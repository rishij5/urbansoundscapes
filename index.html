<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Urban Soundscapes</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&family=SN+Pro:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-dark: rgba(15, 15, 15, 0.9);
            --border-color: #444;
            --accent-white: #ffffff;
            --font-main: "Kantumruy Pro", sans-serif;
            --font-heading: "SN Pro", sans-serif;
        }

        body { margin: 0; padding: 0; font-family: var(--font-main); background: #000; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh; }

        #ui-panel {
            position: fixed; top: 20px; right: 20px; z-index: 10;
            background: var(--bg-dark); color: white; padding: 20px;
            border-radius: 12px; border: 1px solid var(--border-color); width: 220px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
        }

        /* Animation for sliding the panel out */
#ui-panel {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Class to apply when minimized */
#ui-panel.minimized {
    transform: translateX(calc(100% + 20px));
}

/* The toggle button styling */
#toggle-panel-btn {
    position: absolute;
    left: -40px; /* Sits just outside the panel */
    top: 0;
    width: 32px;
    height: 32px;
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    backdrop-filter: blur(8px);
}
        h2 { font-family: var(--font-heading); font-weight: 700; font-size: 22px; margin: 0 0 10px 0; letter-spacing: 1px; }
        .control-group { margin-top: 15px; }
        .label-tiny { font-size: 11px; color: #888; margin-bottom: 4px; letter-spacing: 0.5px; }
        input[type=range] { width: 100%; margin-top: 10px; cursor: pointer; accent-color: var(--accent-white); }
        .gradient-bar { height: 12px; border-radius: 2px; background: linear-gradient(to right, #000004, #1b0c41, #4b0c6b, #781c6d, #a52c60, #cf4446, #ed6925, #fb9b06, #f7d13d, #fcffa4); }
        .legend-labels { display: flex; justify-content: space-between; font-size: 10px; margin-top: 5px; color: #bbb; }

        /* Target the popup container */
.maplibregl-popup-content {
    background: #111 !important;
    color: white !important; /* Forces all text in popups to be white by default */
    border: 1px solid #444 !important;
    border-radius: 12px !important;
    padding: 15px !important;
    box-shadow: 0 10px 25px rgba(0,0,0,0.6) !important;
}

/* Style the popup close button */
.maplibregl-popup-close-button {
    color: white;
    padding: 5px;
}

/* Style the "tip" (the little triangle at the bottom) */
.maplibregl-popup-anchor-top .maplibregl-popup-tip { border-bottom-color: var(--border-color); }
.maplibregl-popup-anchor-bottom .maplibregl-popup-tip { border-top-color: var(--border-color); }
    </style>
</head>
<body>

    <div id="ui-panel">
        <button id="toggle-panel-btn" title="Toggle Panel">−</button>
        <h2>URBAN SOUNDSCAPES</h2>
        <div id="zoom-level">Zoom: 14.0</div>
        <div class="control-group">
            <div class="label-tiny">DAY OF WEEK</div>
            <select id="day-selector" style="width:100%; background:#222; color:white; border:1px solid #444; border-radius:4px; padding:5px;">
                <option value="0">Monday</option>
                <option value="1">Tuesday</option>
                <option value="2">Wednesday</option>
                <option value="3" selected>Thursday</option>
                <option value="4">Friday</option>
                <option value="5">Saturday</option>
                <option value="6">Sunday</option>
            </select>
        </div>
        <div class="control-group">
            <div id="active-hour" style="font-weight:bold;">12:00 PM</div>
            <input id="slider" type="range" min="0" max="23" step="1" value="23">
        </div>
        <div class="control-group">
            <div class="label-tiny">SOUND LEVEL (dB)</div>
            <div class="gradient-bar"></div>
            <div class="legend-labels"><span>40</span><span>55</span><span>70</span><span>85</span><span>100</span><span>115</span></div>
        </div>
    </div>

    <button id="add-report-btn" style="position: fixed; bottom: 30px; right: 30px; z-index: 20; width: 60px; height: 60px; border-radius: 50%; border: none; background: #e74c3c; color: white; font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4);">+</button>

    <div id="report-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: #1a1a1a; color: white; padding: 25px; border-radius: 12px; width: 320px; border: 1px solid #444;">
            <h3 style="margin-top: 0;">Report Local Vibe</h3>
            <div id="vibe-label" class="label-tiny" style="color: #ed6925; font-weight: bold;">Moderate (55-70 dB)</div>
            <p id="vibe-desc" style="font-size: 12px; color: #bbb;">Coffee shop chatter, light background music.</p>
            <input id="vibe-slider" type="range" min="1" max="4" step="1" value="2">
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button id="cancel-report" style="flex: 1; padding: 10px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button id="submit-report" style="flex: 2; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Submit</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        let visitorId = localStorage.getItem('vibe_visitor_id');
if (!visitorId) {
    visitorId = Math.random().toString(36).substring(2, 15);
    localStorage.setItem('vibe_visitor_id', visitorId);
}
        const SUPABASE_URL = 'https://mjwowewyqsrtyovhmmnf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qd293ZXd5cXNydHlvdmhtbW5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MjEzMjQsImV4cCI6MjA4NzE5NzMyNH0.UgPsfu0BrKGDt5LdJAgsqKHxElocX0LHIoxmj44cE6o';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const vibeData = {
            1: { label: "Quiet (40-55 dB)", desc: "Empty library corner, whispers only.", db: 45 },
            2: { label: "Moderate (55-70 dB)", desc: "Coffee shop chatter, light music.", db: 65 },
            3: { label: "Loud (70-85 dB)", desc: "Busy dining hall, shouting to be heard.", db: 80 },
            4: { label: "Extreme (85+ dB)", desc: "Concert, construction, or active party.", db: 100 }
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            center: [-97.7410, 30.2675],
            zoom: 14,
            maxBounds: [[-97.756408, 30.254275], [-97.729097, 30.301918]],
            minZoom: 12
        });

        const formatTime = (hour) => {
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:00 ${ampm}`;
        };

        map.on('load', async () => {
            // Sources
            map.addSource('user-reports', { type: 'geojson', data: { type: "FeatureCollection", features: [] } });

            // Layer Stack Start
            
            // 1. Student Report Glow (Pulsing)
            map.addLayer({
                id: 'user-reports-glow',
                type: 'circle',
                source: 'user-reports',
                paint: {
                    'circle-radius': 20,
                    'circle-color': '#00f2ff',
                    'circle-blur': 1.5,
                    'circle-opacity': 0.3
                }
            });

            // 2. Student Report Core
            map.addLayer({
                id: 'user-reports-layer',
                type: 'circle',
                source: 'user-reports',
                paint: {
                    'circle-radius': 8,
                    'circle-color': [
                        'match', ['get', 'vibe'],
                        'Quiet (40-55 dB)', '#3498db',
                        'Moderate (55-70 dB)', '#2ecc71',
                        'Loud (70-85 dB)', '#f1c40f',
                        'Extreme (85+ dB)', '#e74c3c',
                        '#00f2ff'
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff',
                    'circle-opacity': ['interpolate', ['linear'], ['get', 'confirms'], 0, 0.5, 3, 1]
                }
            });

            try {
                // 3. Static Heatmap Logic
                const response = await fetch('data.csv');
                const csvString = await response.text();
                const results = Papa.parse(csvString, { skipEmptyLines: true, header: false });
                const geojson = {
                    type: "FeatureCollection",
                    features: results.data.map(p => ({
                        type: "Feature",
                        properties: { db: parseFloat(p[2]), hour: parseInt(p[3]), day: parseInt(p[4]) },
                        geometry: { type: "Point", coordinates: [parseFloat(p[1]), parseFloat(p[0])] }
                    }))
                };
                map.addSource('noise-source', { type: 'geojson', data: geojson });
                
                const firstSymbolId = map.getStyle().layers.find(l => l.type === 'symbol')?.id;

                map.addLayer({
                    id: 'noise-heat',
                    type: 'heatmap',
                    source: 'noise-source',
                    paint: {
                        'heatmap-opacity': 0.7,
                        'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1, 15, 2.5],
                        'heatmap-weight': ['interpolate', ['linear'], ['get', 'db'], 40, 0, 115, 1],
                        'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 10, 5, 15, 30, 18, 150],
                        'heatmap-color': ['interpolate', ['linear'], ['heatmap-density'], 0, 'rgba(0,0,4,0)', 0.1, '#1b0c41', 0.3, '#4b0c6b', 0.5, '#a52c60', 0.7, '#ed6925', 0.9, '#fb9b06', 1, '#fcffa4']
                    }
                }, firstSymbolId);

                // 4. RESTORED: Original Sensor Dots (Pinned to Top)
                map.addLayer({
                    id: 'sensor-dots',
                    type: 'circle',
                    source: 'noise-source',
                    paint: { 
                        'circle-radius': 3, 
                        'circle-color': '#fff', 
                        'circle-stroke-width': 1, 
                        'circle-stroke-color': '#000' 
                    }
                });

                // Hitbox for sensor popups
                map.addLayer({
                    id: 'sensor-hitbox',
                    type: 'circle',
                    source: 'noise-source',
                    paint: { 'circle-radius': 10, 'circle-opacity': 0 }
                });

                setupControls();
            } catch (err) { console.error("CSV Load Error:", err); }

            setupReporting();
            fetchGlobalReports();
            setInterval(fetchGlobalReports, 60000);
            animatePulse();
        });

        // Pulse logic for radius and opacity
        let step = 0;
        function animatePulse() {
            step += 0.05;
            const opacity = (Math.sin(step) * 0.1) + 0.3;
            const radius = (Math.sin(step) * 5) + 20; 

            if (map.getLayer('user-reports-glow')) {
                map.setPaintProperty('user-reports-glow', 'circle-opacity', opacity);
                map.setPaintProperty('user-reports-glow', 'circle-radius', radius);
            }
            requestAnimationFrame(animatePulse);
        }

        async function fetchGlobalReports() {
            const { data, error } = await supabaseClient.from('self_reports').select('*').gt('created_at', new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString());
            if (data) {
                const geojson = {
                    type: "FeatureCollection",
                    features: data.map(r => ({
                        type: "Feature",
                        properties: { db: r.db_level, vibe: r.vibe_label, id: r.id, confirms: r.confirmations || 0 },
                        geometry: { type: "Point", coordinates: [r.lng, r.lat] }
                    }))
                };
                map.getSource('user-reports').setData(geojson);
            }
        }

        function setupReporting() {
            const modal = document.getElementById('report-modal');
            const slider = document.getElementById('vibe-slider');
            document.getElementById('add-report-btn').onclick = () => modal.style.display = 'flex';
            document.getElementById('cancel-report').onclick = () => modal.style.display = 'none';
            slider.oninput = (e) => {
                const val = e.target.value;
                document.getElementById('vibe-label').innerText = vibeData[val].label;
                document.getElementById('vibe-desc').innerText = vibeData[val].desc;
            };
            document.getElementById('submit-report').onclick = async () => {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const vibe = vibeData[slider.value];
                    const { error } = await supabaseClient.from('self_reports').insert([{ 
    lat: pos.coords.latitude, 
    lng: pos.coords.longitude, 
    db_level: vibe.db, 
    vibe_label: vibe.label,
    user_id: visitorId // Tag the report with your ID
}]);
                    if (!error) { modal.style.display = 'none'; fetchGlobalReports(); alert("Vibe reported!"); }
                }, (err) => alert("Please enable GPS."));
            };
        }

        function setupControls() {
            const slider = document.getElementById('slider');
            const day = document.getElementById('day-selector');
            const update = () => {
                const h = parseInt(slider.value);
                const filter = ['all', ['==', ['get', 'hour'], h], ['==', ['get', 'day'], parseInt(day.value)]];
                // Apply filter to static heatmap and sensor dots
                ['noise-heat', 'sensor-dots', 'sensor-hitbox'].forEach(id => map.setFilter(id, filter));
                document.getElementById('active-hour').innerText = formatTime(h);
            };
            slider.oninput = update;
            day.onchange = update;
            update();
        }

       window.confirmReport = async (id) => {
    // Generate or get a persistent ID for this browser
    let visitorId = localStorage.getItem('vibe_visitor_id');
    if (!visitorId) {
        visitorId = Math.random().toString(36).substring(2, 15);
        localStorage.setItem('vibe_visitor_id', visitorId);
    }

    // Call the updated function with the visitorId
    const { error } = await supabaseClient.rpc('increment_confirmations', { 
        row_id: id, 
        visitor_id: visitorId 
    });
    
    if (error) {
        // This will now show the 'Already verified' message from the database
        alert(error.message.includes('already verified') ? "You've already verified this!" : "Error processing verification.");
    } else {
        fetchGlobalReports();
        alert("Thanks for verifying!");
    }
};

        // Click interaction for Sensor Dots
        map.on('click', 'sensor-hitbox', (e) => {
    const { db, hour } = e.features[0].properties;
    new maplibregl.Popup()
        .setLngLat(e.features[0].geometry.coordinates)
        .setHTML(`
            <div style="font-family: 'SN Pro', sans-serif;">
                <div style="font-size: 10px; color: #888; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px;">Historical Sensor Data</div>
                <div style="font-size: 14px; font-weight: bold; margin-bottom: 2px;">Recorded at ${formatTime(hour)}</div>
                <div style="font-size: 24px; font-weight: 700; color: #ed6925;">${db} <span style="font-size: 12px;">dB</span></div>
            </div>
        `)
        .addTo(map);
});

        // Click interaction for Student Reports
       map.on('click', 'user-reports-layer', (e) => {
    const p = e.features[0].properties;
    
    // Check if the current user owns this report
    const isOwner = p.user_id === visitorId;
    const deleteBtn = isOwner ? 
        `<button onclick="deleteReport(${p.id})" style="margin-top:8px; background:#ff4d4d; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; width:100%; font-size:11px;">Delete My Report</button>` : '';

    new maplibregl.Popup()
        .setLngLat(e.features[0].geometry.coordinates)
        .setHTML(`
            <div style="text-align:center; color:white;">
                <div style="font-size:10px; color:#888; text-transform:uppercase;">Student Report</div>
                <b style="color:#00f2ff; font-size:16px;">${p.vibe}</b><br>
                <button onclick="confirmReport(${p.id})" style="margin-top:8px; background:#00f2ff; color:black; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold; width:100%;">Sounds Right! (${p.confirms})</button>
                ${deleteBtn}
            </div>
        `).addTo(map);
});

        map.on('mouseenter', 'sensor-hitbox', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'sensor-hitbox', () => map.getCanvas().style.cursor = '');
        map.on('mouseenter', 'user-reports-layer', () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', 'user-reports-layer', () => map.getCanvas().style.cursor = '');
        
        map.on('zoom', () => document.getElementById('zoom-level').innerText = `Zoom: ${map.getZoom().toFixed(1)}`);
        const panel = document.getElementById('ui-panel');
const toggleBtn = document.getElementById('toggle-panel-btn');

toggleBtn.onclick = () => {
    panel.classList.toggle('minimized');
    // Change the icon from minus to gear/plus when hidden
    toggleBtn.innerText = panel.classList.contains('minimized') ? "⚙" : "−";
};

window.deleteReport = async (id) => {
    if (!confirm("Remove this report from the map?")) return;
    const { error } = await supabaseClient.from('self_reports').delete().eq('id', id);
    if (!error) {
        fetchGlobalReports();
        map.getCanvas().style.cursor = '';
        // Close any open popups
        const popups = document.getElementsByClassName('maplibregl-popup');
        while(popups[0]) popups[0].remove();
    }
};
    </script>
</body>
</html>
